<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CurseStudio | Stable V15</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --bg: #36393f; --dark: #2f3136; --v-dark: #202225; --accent: #5865f2; --admin-red: #ff4747; --admin-blue: #00d2ff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Whitney', 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: #dcddde; height: 100vh; display: flex; overflow: hidden; }
        #sidebar, #member-list { width: 240px; background: var(--dark); display: none; flex-direction: column; border: 1px solid #222; }
        #main { flex: 1; display: none; flex-direction: column; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px 0; }
        .msg { padding: 8px 20px; position: relative; }
        .msg-tools { position: absolute; right: 20px; top: 5px; display: none; gap: 10px; background: var(--v-dark); padding: 5px 10px; border-radius: 5px; border: 1px solid #444; z-index: 10; }
        .msg:hover .msg-tools { display: flex; }
        .tool-btn { cursor: pointer; font-size: 13px; opacity: 0.8; }
        .tool-btn:hover { opacity: 1; color: var(--accent); }
        .reply-orig { border-left: 2px solid var(--accent); padding-left: 10px; font-size: 12px; opacity: 0.7; margin-bottom: 5px; }

        /* YayÄ±n AlanÄ± */
        .stream-box { width: 320px; border-radius: 8px; overflow: hidden; background: #000; margin-top: 10px; border: 2px solid var(--accent); position: relative; cursor: pointer; }
        .stream-box video { width: 100%; display: block; }
        .live-tag { position: absolute; top: 8px; left: 8px; background: var(--admin-red); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; z-index: 5; }

        #stream-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.98); z-index:9999; flex-direction: column; align-items: center; justify-content: center; }
        #full-video { width: 90%; max-height: 80vh; border-radius: 8px; box-shadow: 0 0 20px var(--accent); }

        .btn-side { width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-stop { background: var(--admin-red) !important; color: white !important; }
        
        .nick { font-weight: 600; }
        .nick.kurucu { color: var(--admin-red); }
        .nick.admin-volar { color: var(--admin-blue); }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 5px; font-weight: bold; }
        #auth-overlay { position: fixed; inset: 0; background: #2f3136; display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .input-wrap { padding: 20px; }
        .inner-input { background: #40444b; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 10px; }
        #chat-in { background: transparent; border: none; color: white; flex: 1; outline: none; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div style="text-align:center; background:var(--v-dark); padding:40px; border-radius:12px;">
        <h2 style="color:white; margin-bottom:20px">CurseStudio</h2>
        <input type="text" id="user-nick" placeholder="KullanÄ±cÄ± adÄ±..." style="width:300px; padding:14px; background:#36393f; border:1px solid #111; color:white; border-radius:5px; margin-bottom:20px;"><br>
        <button onclick="login()" style="width:300px; padding:15px; background:var(--accent); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GÄ°RÄ°Åž YAP</button>
    </div>
</div>

<div id="sidebar">
    <div style="padding:15px; font-weight:bold; border-bottom:1px solid #222">CurseStudio</div>
    <div id="chan-list" style="flex:1; padding:10px"></div>
    <div style="padding:15px; border-top:1px solid #222">
        <button id="stream-btn" class="btn-side" style="background:var(--accent); color:white" onclick="handleStreamClick()">ðŸ“º EkranÄ± PaylaÅŸ</button>
        <button id="dnd-btn" class="btn-side" style="background:#444; color:white" onclick="toggleDND()">ðŸ”” Bildirimler: AÃ‡IK</button>
    </div>
</div>

<div id="main">
    <div id="messages"></div>
    <div id="alert-zone" style="padding-left:20px"></div>
    <div class="input-wrap">
        <div id="reply-bar" style="display:none; background:#2f3136; padding:8px 20px; border-bottom:1px solid #444; border-radius:8px 8px 0 0; justify-content:space-between; align-items:center;">
            <div id="reply-text" class="reply-orig"></div>
            <span onclick="cancelReply()" style="cursor:pointer; color:var(--admin-red)">âœ•</span>
        </div>
        <div class="inner-input" id="drop-area">
            <label for="f-up" style="cursor:pointer; color:gray; font-size:20px">+</label>
            <input type="file" id="f-up" style="display:none" onchange="handleFile(this.files[0])">
            <input type="text" id="chat-in" placeholder="Mesaj gÃ¶nder..." onkeypress="if(event.key==='Enter') handleSend()">
        </div>
    </div>
</div>

<div id="member-list">
    <div style="padding:20px; font-size:12px; font-weight:bold; color:gray">Ã‡EVRÄ°MÄ°Ã‡Ä°</div>
    <div id="members-ui" style="padding:0 10px"></div>
</div>

<div id="stream-modal">
    <video id="full-video" autoplay controls></video>
    <button onclick="closeModal()" style="margin-top:20px; padding:10px 30px; background:var(--admin-red); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold">KAPAT</button>
</div>

<script>
const KURUCU = "The1545", ADMIN = "Volar";
const firebaseConfig = {
    apiKey: "AIzaSyCnoxoPsUFx3f71SAcV7vd5ex_ZUmOk3e0",
    authDomain: "cursestudio-chat.firebaseapp.com",
    databaseURL: "https://cursestudio-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cursestudio-chat",
    storageBucket: "cursestudio-chat.appspot.com",
    messagingSenderId: "6190203668",
    appId: "1:6190203668:web:bb7475428ab3f96c62b801"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myNick = "", activeC = "genel", isDND = false, replyTo = null, myStream = null;
let lastMsgTime = Date.now(); // Bildirim spamÄ±nÄ± Ã¶nlemek iÃ§in

function login() {
    myNick = document.getElementById('user-nick').value.trim();
    if(!myNick) return;
    db.ref('bans/' + myNick).once('value', s => {
        if(s.exists()) return alert("BanlÄ±sÄ±nÄ±z!");
        Notification.requestPermission();
        document.getElementById('auth-overlay').style.display = "none";
        document.querySelectorAll('#sidebar, #main, #member-list').forEach(el => el.style.display = "flex");
        db.ref('presence/' + myNick).set(true);
        db.ref('presence/' + myNick).onDisconnect().remove();
        initApp();
    });
}

function initApp() {
    // Mesaj Dinleyici (Spam Ã¶nleyici filtre ile)
    db.ref('msgs/' + activeC).on('child_added', s => {
        const d = s.val();
        renderMsg(d, s.key);
        
        // Sadece giriÅŸten SONRA gelen ve baÅŸkasÄ±na ait mesajlar iÃ§in bildirim
        if(!isDND && d.n !== myNick && d.t > lastMsgTime) {
            new Notification("CurseStudio: " + d.n, { body: d.m || "Dosya gÃ¶nderdi." });
        }
    });

    db.ref('presence').on('value', s => {
        const ui = document.getElementById('members-ui'); ui.innerHTML = "";
        Object.keys(s.val() || {}).forEach(u => {
            ui.innerHTML += `<div style="margin-bottom:8px"><span class="nick ${u===KURUCU?'kurucu':u===ADMIN?'admin-volar':''}">${u}</span></div>`;
        });
    });

    db.ref('active_stream').on('value', s => {
        const data = s.val();
        const btn = document.getElementById('stream-btn');
        if(data && data.owner === myNick) {
            btn.innerText = "ðŸ›‘ YayÄ±nÄ± Kapat";
            btn.classList.add('btn-stop');
        } else {
            btn.innerText = "ðŸ“º EkranÄ± PaylaÅŸ";
            btn.classList.remove('btn-stop');
        }
    });

    // Dosya/YapÄ±ÅŸtÄ±r
    window.onpaste = (e) => { const f = e.clipboardData.files[0]; if(f) handleFile(f); };
    document.getElementById('drop-area').ondrop = (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };
}

function renderMsg(d, id) {
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = "msg";
    const isStaff = (myNick === KURUCU || myNick === ADMIN);

    let body = d.m ? `<div>${d.m}</div>` : '';
    if(d.img) body += `<img src="${d.img}" style="max-width:300px; border-radius:8px; margin-top:8px; cursor:pointer" onclick="window.open(this.src)">`;
    if(d.file) body += `<a href="${d.file}" download="${d.fileName}" style="color:var(--accent); display:block; margin-top:8px">ðŸ“„ ${d.fileName}</a>`;
    
    // YayÄ±n GÃ¶rÃ¼nÃ¼mÃ¼
    if(d.type === 'stream') {
        body += `<div class="stream-box" onclick="openFullStream()">
                    <div class="live-tag">CANLI</div>
                    <video id="preview-video" autoplay muted></video>
                 </div>`;
    }

    let replyHtml = d.reply ? `<div class="reply-orig"><b>@${d.reply.n}:</b> ${d.reply.m}</div>` : '';

    div.innerHTML = `
        ${replyHtml}
        <div style="display:flex; justify-content:space-between">
            <div>
                <span class="nick ${d.n===KURUCU?'kurucu':d.n===ADMIN?'admin-volar':''}">${d.n}</span>
                <span style="color:gray; font-size:10px">${new Date(d.t).toLocaleTimeString()}</span>
                ${body}
            </div>
            <div class="msg-tools">
                <span class="tool-btn" onclick="startReply('${d.n}', '${(d.m||"Dosya").replace(/'/g,"")}')">â†© YanÄ±tla</span>
                ${(d.n === myNick || isStaff) ? `<span class="tool-btn" style="color:var(--admin-red)" onclick="deleteMsg('${id}')">ðŸ—‘ Sil</span>` : ''}
            </div>
        </div>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function handleSend() {
    const el = document.getElementById('chat-in');
    const val = el.value.trim();
    if(!val) return;

    if(val.startsWith('/')) {
        const p = val.split(' '); const cmd = p[0]; const target = p[1];
        if(target === KURUCU) { showAlert("Kurucuya dokunamazsÄ±n!"); el.value = ""; return; }
        if(myNick === KURUCU || myNick === ADMIN) {
            if(cmd === '/ban') db.ref('bans/' + target).set(true);
            if(cmd === '/mute') db.ref('mutes/' + target).set(true);
            if(cmd === '/unmute') db.ref('mutes/' + target).remove();
            if(cmd === '/clear') db.ref('msgs/' + activeC).remove();
        }
        el.value = ""; return;
    }

    db.ref('mutes/' + myNick).once('value', s => {
        if(s.exists()) { showAlert("Mutelisin!"); el.value = ""; }
        else {
            const payload = { n: myNick, m: val, t: Date.now() };
            if(replyTo) { payload.reply = replyTo; cancelReply(); }
            db.ref('msgs/' + activeC).push(payload);
            el.value = "";
        }
    });
}

// YAYIN MANTIÄžI
async function handleStreamClick() {
    if(myStream) {
        stopSharing();
    } else {
        startSharing();
    }
}

async function startSharing() {
    try {
        myStream = await navigator.mediaDevices.getDisplayMedia({video:true});
        db.ref('active_stream').set({owner: myNick});
        db.ref('msgs/' + activeC).push({n: myNick, type:'stream', t: Date.now()});
        
        myStream.getVideoTracks()[0].onended = stopSharing;
    } catch(e) { console.log(e); }
}

function stopSharing() {
    if(myStream) {
        myStream.getTracks().forEach(t => t.stop());
        myStream = null;
    }
    db.ref('active_stream').remove();
    db.ref('msgs/' + activeC).push({n: "Sistem", m: "ðŸ”´ YayÄ±n sona erdi.", t: Date.now()});
}

function openFullStream() {
    const modal = document.getElementById('stream-modal');
    const vid = document.getElementById('full-video');
    modal.style.display = "flex";
    if(myStream) vid.srcObject = myStream;
}

function closeModal() { document.getElementById('stream-modal').style.display = "none"; }
function startReply(n, m) { replyTo = { n, m }; document.getElementById('reply-bar').style.display = "flex"; document.getElementById('reply-text').innerText = "@" + n + ": " + m; document.getElementById('chat-in').focus(); }
function cancelReply() { replyTo = null; document.getElementById('reply-bar').style.display = "none"; }
function deleteMsg(id) { if(confirm("Silinsin mi?")) db.ref('msgs/' + activeC + '/' + id).remove(); }
function toggleDND() { isDND = !isDND; const b = document.getElementById('dnd-btn'); b.innerText = isDND ? "ðŸ”‡ Bildirimler: KAPALI" : "ðŸ”” Bildirimler: AÃ‡IK"; b.style.background = isDND ? "#ff4747" : "#444"; }
function handleFile(f) { if(!f) return; const r = new FileReader(); r.onload = e => db.ref('msgs/' + activeC).push({ n: myNick, t: Date.now(), [f.type.startsWith('image/')?'img':'file']: e.target.result, fileName: f.name }); r.readAsDataURL(f); }
function showAlert(t) { const z = document.getElementById('alert-zone'); z.innerHTML = `<div style="color:red; font-size:12px; font-weight:bold">${t}</div>`; setTimeout(() => z.innerHTML = "", 3000); }
</script>
</body>
</html>