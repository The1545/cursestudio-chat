<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CurseStudio</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --bg: #36393f; --dark: #2f3136; --v-dark: #202225; --accent: #5865f2; 
            --admin-red: #ff4747; --admin-orange: #ff9f43; --bot-green: #2ecc71;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: var(--bg); color: #dcddde; height: 100vh; display: flex; overflow: hidden; }
        
        /* Auth */
        #auth-overlay { position: fixed; inset: 0; background: #2f3136; display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .auth-box { text-align: center; background: var(--v-dark); padding: 40px; border-radius: 10px; }
        .auth-box h2 { color: white; margin-bottom: 25px; letter-spacing: -1px; font-size: 28px; }
        .auth-box input { width: 280px; padding: 12px; background: #36393f; border: 1px solid #111; color: white; border-radius: 5px; margin-bottom: 20px; outline: none; }

        /* Sidebar */
        #sidebar { width: 260px; background: var(--dark); border-right: 1px solid var(--v-dark); display: none; flex-direction: column; }
        .side-header { padding: 15px; font-weight: bold; color: white; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .channel-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .channel-btn { padding: 10px 15px; margin: 2px 10px; cursor: pointer; color: #8e9297; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .channel-btn.active { background: #4f545c; color: #fff; }
        .edit-btn { cursor: pointer; opacity: 0.6; font-size: 14px; }
        .edit-btn:hover { opacity: 1; color: var(--accent); }

        /* Main Chat */
        #main { flex: 1; display: none; flex-direction: column; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; }
        .msg { margin-bottom: 15px; }
        .nick { font-weight: bold; margin-right: 8px; }
        .nick.kurucu { color: var(--admin-red); }
        .nick.admin-volar { color: var(--admin-orange); }
        .badge { font-size: 9px; padding: 2px 6px; border-radius: 3px; color: white; margin-right: 8px; font-weight: bold; }

        /* Fullscreen Button */
        #fs-btn { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.3s; }
        #fs-btn:hover { background: var(--accent); transform: scale(1.1); }

        /* Modals */
        #mgmt-modal, #name-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; align-items:center; justify-content:center; }
        .modal-box { background:var(--dark); padding:30px; border-radius:8px; width:380px; border:1px solid #444; }
        .modal-box input, .modal-box select { width:100%; padding:10px; background:var(--v-dark); border:1px solid #111; color:white; border-radius:4px; margin-bottom:15px; }

        .input-wrap { padding: 20px; }
        .inner-input { background: #40444b; border-radius: 8px; padding: 12px; display: flex; align-items: center; }
        #chat-in { background: transparent; border: none; color: white; flex: 1; outline: none; margin-left: 10px; }
        .chat-img { max-width: 400px; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-box">
        <h2>CurseStudio</h2>
        <input type="text" id="user-nick" placeholder="Kullanƒ±cƒ± adƒ±nƒ±z..." maxlength="15">
        <br>
        <button onclick="login()" style="width:280px; padding:12px; background:var(--accent); color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer">BAƒûLAN</button>
    </div>
</div>

<div id="sidebar">
    <div class="side-header">
        <span id="server-name-display">Y√ºkleniyor...</span>
        <span id="edit-server-btn" class="edit-btn" onclick="openNameModal()" style="display:none">‚úé</span>
    </div>
    <div class="channel-list" id="chan-list"></div>
    <div id="admin-tools" style="padding:15px; display:none">
        <button onclick="openMgmt()" style="width:100%; padding:10px; background:#3ba55c; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold">‚öôÔ∏è Kanal Y√∂netimi</button>
    </div>
    <div style="padding:15px; font-size:12px; color:#f04747; cursor:pointer; text-align:center" onclick="location.reload()">Oturumu Kapat</div>
</div>

<div id="main">
    <div id="messages"></div>
    <div class="input-wrap">
        <div class="inner-input">
            <label for="f-up" style="cursor:pointer; color:#b9bbbe; font-size:20px">+</label>
            <input type="file" id="f-up" style="display:none" onchange="upFile(this)">
            <input type="text" id="chat-in" placeholder="Mesaj g√∂nder..." onkeypress="if(event.key==='Enter') send()">
        </div>
    </div>
    <button id="fs-btn" onclick="toggleFullScreen()" title="Tam Ekran">‚õ∂</button>
</div>

<div id="name-modal">
    <div class="modal-box">
        <h3 style="color:white; margin-bottom:15px">Sunucu Adƒ±nƒ± D√ºzenle</h3>
        <input type="text" id="new-server-name" placeholder="Yeni sunucu adƒ±...">
        <button onclick="updateServerName()" style="background:var(--accent); padding:12px; width:100%; border:none; color:white; border-radius:4px; cursor:pointer; font-weight:bold">G√úNCELLE</button>
        <button onclick="closeNameModal()" style="margin-top:10px; background:transparent; color:#72767d; border:none; width:100%; cursor:pointer">ƒ∞ptal</button>
    </div>
</div>

<div id="mgmt-modal">
    <div class="modal-box">
        <h3 style="color:white; margin-bottom:15px">Yeni Kanal Olu≈ütur</h3>
        <input type="text" id="new-chan-name" placeholder="Kanal adƒ±...">
        <select id="new-chan-type">
            <option value="public">Herkese A√ßƒ±k</option>
            <option value="private">Sadece Yetkililer (Kilitli)</option>
        </select>
        <button onclick="createChan()" style="background:var(--accent); padding:12px; width:100%; border:none; color:white; border-radius:4px; cursor:pointer; font-weight:bold">OLU≈ûTUR</button>
        <div id="delete-zone" style="margin-top:20px; border-top:1px solid #444; padding-top:15px">
            <button onclick="deleteChan()" style="background:#ed4245; padding:8px; width:100%; border:none; color:white; border-radius:4px; cursor:pointer">KANALI Sƒ∞L</button>
        </div>
        <button onclick="closeMgmt()" style="margin-top:10px; background:transparent; color:#72767d; border:none; width:100%; cursor:pointer">ƒ∞ptal</button>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCnoxoPsUFx3f71SAcV7vd5ex_ZUmOk3e0",
    authDomain: "cursestudio-chat.firebaseapp.com",
    databaseURL: "https://cursestudio-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cursestudio-chat",
    storageBucket: "cursestudio-chat.appspot.com",
    messagingSenderId: "6190203668",
    appId: "1:6190203668:web:bb7475428ab3f96c62b801"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myNick = "", activeChan = "genel", chanData = {};
const KURUCU = "The1545", ADMIN = "Volar";

// Giri≈ü ƒ∞≈ülemi
function login() {
    myNick = document.getElementById('user-nick').value.trim();
    if(!myNick) return;
    document.getElementById('auth-overlay').style.display = "none";
    document.getElementById('sidebar').style.display = "flex";
    document.getElementById('main').style.display = "flex";
    
    if(myNick === KURUCU) {
        document.getElementById('admin-tools').style.display = "block";
        document.getElementById('edit-server-btn').style.display = "inline";
    }
    
    setupDefaultChannels();
    listenServerName();
    loadChannels();
}

// Sunucu Adƒ±nƒ± Veritabanƒ±ndan Dinle
function listenServerName() {
    db.ref('server_settings/name').on('value', snap => {
        const name = snap.val() || "CurseStudio";
        document.getElementById('server-name-display').innerText = name;
        document.title = name;
    });
}

// Sunucu Adƒ±nƒ± G√ºncelle (Sadece Kurucu)
function updateServerName() {
    const newName = document.getElementById('new-server-name').value.trim();
    if(!newName) return;
    db.ref('server_settings/name').set(newName).then(() => {
        closeNameModal();
    });
}

function openNameModal() { document.getElementById('name-modal').style.display = "flex"; }
function closeNameModal() { document.getElementById('name-modal').style.display = "none"; }

// Fullscreen Fonksiyonu
function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

// Diƒüer Fonksiyonlar (Kanal, Mesaj vb.)
function setupDefaultChannels() {
    db.ref('channels/genel').once('value', s => { if(!s.exists()) db.ref('channels/genel').set({type:'public'}); });
    db.ref('channels/duyurular').once('value', s => { if(!s.exists()) db.ref('channels/duyurular').set({type:'private'}); });
}

function loadChannels() {
    db.ref('channels').on('value', snap => {
        const list = document.getElementById('chan-list');
        list.innerHTML = "";
        chanData = snap.val() || {};
        Object.keys(chanData).forEach(id => {
            const div = document.createElement('div');
            div.className = `channel-btn ${activeChan === id ? 'active' : ''}`;
            div.innerHTML = `<span># ${id}</span> ${chanData[id].type === "private" ? 'üîí' : ''}`;
            div.onclick = () => switchChan(id);
            list.appendChild(div);
        });
    });
}

function switchChan(id) {
    if(chanData[id]?.type === "private" && (myNick !== KURUCU && myNick !== ADMIN)) return alert("Kilitli!");
    activeChan = id;
    loadChannels();
    document.getElementById('messages').innerHTML = "";
    db.ref('msgs/' + id).off();
    db.ref('msgs/' + id).limitToLast(50).on('child_added', snap => render(snap.val()));
}

function send(img = null) {
    const input = document.getElementById('chat-in');
    const val = input.value.trim();
    if(!val && !img) return;
    if(val === "/clear" && (myNick === KURUCU || myNick === ADMIN)) {
        db.ref('msgs/' + activeChan).remove().then(() => {
            db.ref('msgs/' + activeChan).push({n: "CurseBot", m: `Sohbet temizlendi: #${activeChan}`, t: Date.now(), isBot: true});
        });
        input.value = ""; return;
    }
    db.ref('msgs/' + activeChan).push({ n: myNick, m: val, img: img, t: Date.now() });
    input.value = "";
}

function render(d) {
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = "msg";
    const isK = d.n === KURUCU, isA = d.n === ADMIN, isB = d.isBot;
    div.innerHTML = `
        <div>
            ${isK?'<span class="badge" style="background:var(--admin-red)">KURUCU</span>':isA?'<span class="badge" style="background:var(--admin-orange)">ADMƒ∞N</span>':isB?'<span class="badge" style="background:var(--bot-green)">SYSTEM</span>':''}
            <span class="nick ${isK?'kurucu':isA?'admin-volar':isB?'bot':''}">${d.n}</span>
            <span style="font-size:10px; color:#72767d">${new Date(d.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        </div>
        ${d.m ? `<div style="margin-top:5px">${d.m}</div>` : ''}
        ${d.img ? `<img src="${d.img}" class="chat-img" onclick="window.open(this.src)">` : ''}
    `;
    box.appendChild(div); box.scrollTop = box.scrollHeight;
}

function openMgmt() { document.getElementById('mgmt-modal').style.display = "flex"; }
function closeMgmt() { document.getElementById('mgmt-modal').style.display = "none"; }
function createChan() {
    const name = document.getElementById('new-chan-name').value.trim().toLowerCase().replace(/\s+/g, '-');
    const type = document.getElementById('new-chan-type').value;
    if(name) db.ref('channels/' + name).set({ type: type }).then(closeMgmt);
}
function deleteChan() {
    if(activeChan === "genel" || activeChan === "duyurular") return;
    db.ref('channels/' + activeChan).remove();
    db.ref('msgs/' + activeChan).remove();
    switchChan('genel'); closeMgmt();
}
function upFile(el) {
    if(el.files[0]) {
        const reader = new FileReader();
        reader.onload = e => send(e.target.result);
        reader.readAsDataURL(el.files[0]);
    }
}
</script>
</body>
</html>