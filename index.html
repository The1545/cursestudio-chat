<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CurseStudio Chat</title>
<style>
body{margin:0;font-family:sans-serif;background:#36393f;color:#dcddde;height:100vh;overflow:hidden;display:flex;flex-direction:column;}
#loginScreen{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#2f3136;}
#loginScreen input,#loginScreen button{padding:10px;margin:5px;border:none;border-radius:5px;}
#chatScreen{display:none;flex:1;flex-direction:row;}
#sidebar{width:250px;background:#2f3136;display:flex;flex-direction:column;}
#channels{padding:10px;flex:0;}
#channels button{background:#202225;color:#dcddde;border:none;padding:8px;margin:3px;border-radius:5px;text-align:left;cursor:pointer;}
#channels button.active{background:#5865f2;color:white;}
#users{flex:1;padding:10px;overflow-y:auto;border-top:1px solid #40444b;}
.userItem{display:flex;align-items:center;margin:3px 0;}
.userItem span{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px;}
#mainChat{flex:1;display:flex;flex-direction:column;background:#36393f;}
#messages{flex:1;padding:10px;overflow-y:auto;}
.message{margin:5px 0;padding:5px 10px;border-radius:5px;max-width:80%;word-wrap:break-word;}
.message.you{background:#7289da;color:white;align-self:flex-end;}
.message.other{background:#40444b;color:white;align-self:flex-start;}
.message.announcement{background:#faa61a;color:black;font-weight:bold;align-self:center;}
.message .nick{font-weight:bold;margin-right:5px;}
#inputArea{display:flex;padding:10px;background:#40444b;}
#inputArea input[type="text"]{flex:1;padding:10px;border:none;border-radius:5px;margin-right:5px;}
#inputArea input[type="file"]{margin-right:5px;}
#inputArea button{padding:10px;border:none;border-radius:5px;background:#5865f2;color:white;cursor:pointer;}
img.chatImg{max-width:150px;max-height:150px;border-radius:5px;margin-top:5px;}
</style>
</head>
<body>

<div id="loginScreen">
  <h2>CurseStudio Chat</h2>
  <input type="text" id="nickInput" placeholder="Nick gir veya Skip ile rastgele">
  <input type="password" id="passInput" placeholder="Şifre (yeni kullanıcı için kaydet)">
  <button id="skipBtn">Skip</button>
  <button id="loginBtn">Giriş / Kayıt</button>
</div>

<div id="chatScreen">
  <div id="sidebar">
    <div id="channels">
      <button class="active" data-channel="general">#Genel</button>
      <button data-channel="announcements">#Duyurular</button>
    </div>
    <div id="users"></div>
  </div>
  <div id="mainChat">
    <div id="messages"></div>
    <div id="inputArea">
      <input type="text" id="msgInput" placeholder="Mesajını yaz...">
      <input type="file" id="fileInput">
      <button id="sendBtn">Gönder</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, get, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCnoxoPsUFx3f71SAcV7vd5ex_ZUmOk3e0",
  authDomain: "cursestudio-chat.firebaseapp.com",
  databaseURL: "https://cursestudio-chat-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cursestudio-chat",
  storageBucket: "cursestudio-chat.appspot.com",
  messagingSenderId: "6190203668",
  appId: "1:6190203668:web:bb7475428ab3f96c62b801"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

let currentNick = "";
let currentChannel = "general";
let isAdmin = false;

// DOM
const loginScreen = document.getElementById('loginScreen');
const chatScreen = document.getElementById('chatScreen');
const nickInput = document.getElementById('nickInput');
const passInput = document.getElementById('passInput');
const skipBtn = document.getElementById('skipBtn');
const loginBtn = document.getElementById('loginBtn');
const messagesDiv = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');
const channelsBtns = document.querySelectorAll('#channels button');
const usersDiv = document.getElementById('users');

function randomNick(){return 'User'+Math.floor(Math.random()*10000);}
skipBtn.onclick=()=>{nickInput.value=randomNick();};

loginBtn.onclick=async()=>{
  let nick = nickInput.value.trim().substring(0,20);
  let pass = passInput.value.trim();
  if(!nick) nick=randomNick();
  if(!/^[a-zA-Z0-9ğüşi.<>|"é!'^+%&/()=?_\-*#$½{}\[\]\\|]+$/.test(nick)){alert("Geçersiz karakter");return;}
  const userRef = ref(db,'users/'+nick);
  const snap = await get(userRef);
  if(snap.exists()){
    if(snap.val().pass!==pass){alert("Şifre yanlış");return;}
  }else{
    await set(userRef,{pass:pass});
  }
  currentNick=nick;
  if(nick==="The1545") isAdmin=true;
  loginScreen.style.display="none";
  chatScreen.style.display="flex";
  set(ref(db,'users/'+currentNick+'/online'),true);
  onDisconnect(ref(db,'users/'+currentNick+'/online')).set(false);
  loadUsers();
  loadMessages();
};

function loadUsers(){
  const usersRef = ref(db,'users');
  onValue(usersRef,snap=>{
    usersDiv.innerHTML='';
    snap.forEach(u=>{
      const div = document.createElement('div');
      div.className='userItem';
      const status = document.createElement('span');
      status.style.backgroundColor = u.val().online?'#3ba55c':'#747f8d';
      const nickSpan = document.createElement('span');
      nickSpan.textContent = u.key;
      div.appendChild(status);
      div.appendChild(nickSpan);
      usersDiv.appendChild(div);
    });
  });
}

function loadMessages(){
  const msgsRef = ref(db,'messages/'+currentChannel);
  onChildAdded(msgsRef,(snap)=>{
    const data = snap.val();
    const msgEl = document.createElement('div');
    msgEl.className='message '+(data.nick===currentNick?'you':(data.nick==='CurseBot'?'announcement':'other'));
    msgEl.innerHTML='<span class="nick">'+data.nick+':</span>'+data.text+(data.img?'<br><img class="chatImg" src="'+data.img+'">':'');
    messagesDiv.appendChild(msgEl);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

sendBtn.onclick=async()=>{
  let text = msgInput.value.substring(0,10000);
  if(!text && !fileInput.files.length) return;
  let imgUrl=null;
  if(fileInput.files.length){
    const file = fileInput.files[0];
    const fRef = sRef(storage,'uploads/'+Date.now()+'_'+file.name);
    await uploadBytes(fRef,file);
    imgUrl = await getDownloadURL(fRef);
  }
  if(currentChannel==='announcements' && !isAdmin){alert("Yalnızca admin yazabilir");return;}
  await push(ref(db,'messages/'+currentChannel),{nick:currentNick,text:text,img:imgUrl});
  msgInput.value='';fileInput.value='';
};

channelsBtns.forEach(btn=>{
  btn.onclick=()=>{
    channelsBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    messagesDiv.innerHTML='';
    currentChannel=btn.dataset.channel;
    loadMessages();
  };
});
</script>

</body>
</html>
