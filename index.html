<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CurseStudio Chat</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
:root {
  --bg-primary: #36393f; --bg-secondary: #2f3136; --bg-tertiary: #202225;
  --channel-hover: #34373c; --text-normal: #dcddde; --text-muted: #72767d;
  --header-primary: #fff; --brand: #5865f2; --online: #3ba55c; --offline: #747f8d;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body{background:var(--bg-primary);color:var(--text-normal);height:100vh;display:flex;overflow:hidden;}
::-webkit-scrollbar{width:8px;height:8px;}::-webkit-scrollbar-track{background:var(--bg-secondary);}::-webkit-scrollbar-thumb{background:var(--bg-tertiary);border-radius:4px;}
#login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;z-index:1000;}
.login-box{background:var(--bg-secondary);padding:30px;border-radius:8px;width:350px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.2);}
.login-box h2{color:var(--header-primary);margin-bottom:15px;}
.login-box input{width:100%;padding:10px;margin-bottom:10px;background:var(--bg-tertiary);border:1px solid #202225;color:white;border-radius:4px;}
.btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:white;transition:.2s;width:100%;margin-bottom:5px;}
.btn-primary{background-color:var(--brand);} .btn-primary:hover{background:#4752c4;}
.btn-secondary{background-color:var(--text-muted);} .btn-secondary:hover{background:#5e6165;}
#sidebar{width:240px;background:var(--bg-secondary);display:flex;flex-direction:column;border-right:1px solid var(--bg-tertiary);}
.server-header{height:48px;padding:12px 16px;box-shadow:0 1px 0 rgba(4,4,5,0.2);font-weight:bold;color:var(--header-primary);display:flex;justify-content:space-between;align-items:center;}
.channels-list{padding:8px;flex:1;overflow-y:auto;}
.channel-item{display:flex;align-items:center;padding:8px;margin-bottom:2px;border-radius:4px;cursor:pointer;color:var(--text-muted);}
.channel-item:hover{background-color:var(--channel-hover);color:var(--text-normal);}
.channel-item.active{background:rgba(79,84,92,0.32);color:var(--header-primary);}
.channel-hash{margin-right:6px;font-size:20px;}
.users-list{padding:10px;background:var(--bg-secondary);border-top:1px solid var(--bg-tertiary);height:30%;overflow-y:auto;}
.user-item{display:flex;align-items:center;margin-bottom:8px;font-size:14px;}
.status-dot{width:10px;height:10px;border-radius:50%;margin-right:8px;background-color:var(--offline);}
.status-dot.online{background-color:var(--online);}
#main-chat{flex:1;display:flex;flex-direction:column;background:var(--bg-primary);}
.chat-header{height:48px;padding:0 16px;display:flex;align-items:center;box-shadow:0 1px 0 rgba(4,4,5,0.02);border-bottom:1px solid rgba(4,4,5,0.2);font-weight:bold;color:var(--header-primary);}
#messages-container{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;}
.message{margin-bottom:15px;display:flex;flex-direction:column;}
.msg-header{display:flex;align-items:baseline;margin-bottom:4px;}
.msg-nick{font-weight:600;margin-right:8px;cursor:pointer;}
.msg-nick[data-online="true"]{color:var(--online);} .msg-nick[data-online="false"]{color:var(--offline);}
.msg-timestamp{font-size:0.75rem;color:var(--text-muted);}
.msg-content{color:var(--text-normal);white-space:pre-wrap;word-wrap:break-word;line-height:1.375rem;}
.msg-image{max-width:300px;max-height:300px;border-radius:4px;margin-top:5px;cursor:pointer;}
.input-area{padding:0 16px 24px;}
.input-wrapper{background:#40444b;border-radius:8px;padding:10px;display:flex;align-items:center;}
.file-upload-label{cursor:pointer;color:var(--text-muted);margin-right:10px;font-size:24px;padding:0 5px;}
.file-upload-label:hover{color:var(--text-normal);}
#msg-input{background:transparent;border:none;color:var(--text-normal);flex:1;outline:none;font-size:1rem;}
#file-input{display:none;}
.admin-badge{background:var(--brand);color:white;font-size:10px;padding:2px 4px;border-radius:3px;margin-left:5px;vertical-align:middle;text-transform:uppercase;}
@media (max-width:768px){#sidebar{width:70px;} .server-header span{display:none;} .channels-list{padding:4px;} .channel-item{font-size:12px;} .input-area{padding:0 8px 16px;} .msg-image{max-width:200px;max-height:200px;}}
</style>
</head>
<body>
<div id="login-overlay">
  <div class="login-box">
    <h2>Hoşgeldiniz</h2>
    <p style="font-size:12px;color:#aaa;margin-bottom:10px;">İzin verilen karakterler: A-Z, 0-9 ve ğüşi.<>|"é!'^+%&/()=?_-*#$½{[]}\|</p>
    <input type="text" id="nick-input" placeholder="Nickname giriniz..." maxlength="20">
    <button class="btn btn-primary" onclick="login()">Giriş Yap</button>
    <button class="btn btn-secondary" onclick="skipLogin()">Rastgele İsim (Skip)</button>
  </div>
</div>
<div id="sidebar" style="display:none;">
  <div class="server-header">Sunucu <button class="btn btn-secondary" style="font-size:10px;padding:2px 5px;" onclick="logout()">Çıkış</button></div>
  <div class="channels-list">
    <div class="channel-item active" onclick="switchChannel('Genel')"><span class="channel-hash">#</span> Genel</div>
    <div class="channel-item" onclick="switchChannel('Duyurular')"><span class="channel-hash">#</span> Duyurular</div>
  </div>
  <div class="users-list"><div style="color:var(--text-muted);font-size:12px;font-weight:bold;margin-bottom:5px;">ÇEVRİMİÇİ</div><div id="users-container"></div></div>
</div>
<div id="main-chat" style="display:none;">
  <div class="chat-header"><span class="channel-hash">#</span> <span id="current-channel-name">Genel</span></div>
  <div id="messages-container"></div>
  <div class="input-area" id="input-area-div">
    <div class="input-wrapper">
      <label for="file-input" class="file-upload-label">+</label>
      <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(this)">
      <input type="text" id="msg-input" placeholder="#Genel kanalına mesaj yaz..." onkeypress="handleEnter(event)">
    </div>
  </div>
</div>

<script>
// --- DUMMY DATABASE ---
let dbDummy = { messages: {Genel:[], Duyurular:[]}, status:{} };

// --- STATE ---
let currentUser = {nick:null, uid:null, isAdmin:false};
let currentChannel = 'Genel';
const allowedChars = /^[a-zA-Z0-9ğüşi\.<>\|"é!'\^\+%&\/\(\)=\?_\-\*#\$½\{\[\]\}\|]+$/;
const ADMIN_NICK = "The1545";
const renderedMessageIds = new Set();

// --- LOGIN ---
window.onload=function(){const sNick=localStorage.getItem('chat_nick'); const sUid=localStorage.getItem('chat_uid'); if(sNick && sUid) setupUser(sNick,sUid);}
function login(){const nick=document.getElementById('nick-input').value.trim(); if(!nick)return alert("Nick girin!"); if(nick.length>20)return alert("En fazla 20 karakter."); if(!allowedChars.test(nick))return alert("İzin verilmeyen karakter!"); setupUser(nick,'user_'+Date.now());}
function skipLogin(){setupUser("User"+Math.floor(Math.random()*10000),'user_'+Date.now());}
function setupUser(nick,uid){currentUser={nick:nick,uid:uid,isAdmin:(nick===ADMIN_NICK)}; localStorage.setItem('chat_nick',nick); localStorage.setItem('chat_uid',uid);
document.getElementById('login-overlay').style.display='none'; document.getElementById('sidebar').style.display='flex'; document.getElementById('main-chat').style.display='flex';
initPresence(); loadMessages(currentChannel); updateInputState();}

// --- LOGOUT ---
function logout(){localStorage.removeItem('chat_nick'); localStorage.removeItem('chat_uid');location.reload();}

// --- PRESENCE ---
function initPresence(){dbDummy.status[currentUser.uid]={nick:currentUser.nick,state:'online'}; renderUserList(dbDummy.status);}
function renderUserList(users){const c=document.getElementById('users-container'); c.innerHTML=''; Object.values(users).forEach(u=>{if(u.state==='online'){const d=document.createElement('div');d.className='user-item';d.innerHTML=`<div class="status-dot online"></div> ${u.nick}`;c.appendChild(d);}});}

// --- CHANNEL ---
function switchChannel(c){currentChannel=c;document.querySelectorAll('.channel-item').forEach(el=>el.classList.remove('active'));[...document.querySelectorAll('.channel-item')].forEach(el=>{if(el.innerText.includes(c)) el.classList.add('active');});document.getElementById('current-channel-name').innerText=c;loadMessages(c);updateInputState();}
function updateInputState(){const i=document.getElementById('msg-input'); const w=document.querySelector('.input-wrapper'); if(currentChannel==='Duyurular'&&!currentUser.isAdmin){i.disabled=true;i.placeholder='Sadece yöneticiler yazabilir.'; w.style.opacity='.5'; document.getElementById('file-input').disabled=true;} else{i.disabled=false;i.placeholder=`#${currentChannel} kanalına mesaj yaz...`;w.style.opacity='1';document.getElementById('file-input').disabled=false;}}

// --- MESSAGES ---
function loadMessages(c){const con=document.getElementById('messages-container'); con.innerHTML=''; dbDummy.messages[c].forEach((msg,i)=>renderMessage(msg,i));}
function renderMessage(msg,key){if(renderedMessageIds.has(key))return; renderedMessageIds.add(key);
const con=document.getElementById('messages-container'); const div=document.createElement('div'); div.className='message';
const isAdmin=msg.nick===ADMIN_NICK; const badge=isAdmin?'<span class="admin-badge">Yönetici</span>':'';
let content=`<div class="msg-content">${msg.text}</div>`; if(msg.image) content+=`<img src="${msg.image}" class="msg-image" onclick="window.open(this.src)">`;
div.innerHTML=`<div class="msg-header"><span class="msg-nick" data-nick="${msg.nick}">${msg.nick}</span>${badge}<span class="msg-timestamp" style="margin-left:8px;">${new Date(msg.timestamp).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})}</span></div>${content}`;
con.appendChild(div); con.scrollTop=con.scrollHeight;}

// --- SEND ---
function handleEnter(e){if(e.key==='Enter') sendMessage();}
function sendMessage(img=null){const input=document.getElementById('msg-input'); const text=input.value.trim(); if(!text&&!img)return; if(text.length>10000)return alert("Mesaj çok uzun!"); if(currentChannel==='Duyurular'&&!currentUser.isAdmin)return alert("Yönetici değil!"); const msg={nick:currentUser.nick,text:text,image:img,timestamp:Date.now()}; dbDummy.messages[currentChannel].push(msg); renderMessage(msg,dbDummy.messages[currentChannel].length-1); input.value='';}

// --- IMAGE ---
function handleFileUpload(inp){if(inp.files&&inp.files[0]){const f=inp.files[0]; if(f.size>2*1024*1024){alert("Resim max 2MB"); inp.value=""; return;} const r=new FileReader(); r.onload=e=>{sendMessage(e.target.result); inp.value='';}; r.readAsDataURL(f);}
}
</script>
</body>
</html>
