<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CurseStudio Chat</title>
<style>
    body { margin:0; font-family:sans-serif; background:#2f3136; color:#dcddde; display:flex; height:100vh; }
    #channels { width:200px; background:#202225; padding:10px; display:flex; flex-direction:column; }
    #channels button { margin:5px 0; background:#36393f; color:#dcddde; border:none; padding:8px; cursor:pointer; text-align:left; }
    #chat-container { flex:1; display:flex; flex-direction:column; }
    #messages { flex:1; padding:10px; overflow-y:auto; }
    .message { margin:5px 0; }
    .message .user { font-weight:bold; margin-right:5px; }
    #input-container { display:flex; background:#40444b; padding:5px; }
    #input-container input[type=text] { flex:1; padding:8px; border:none; border-radius:4px; margin-right:5px; }
    #input-container input[type=file] { display:none; }
    #input-container button { padding:8px; border:none; border-radius:4px; background:#7289da; color:#fff; cursor:pointer; }
    #login { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; flex-direction:column; color:#fff; }
    #login input { padding:8px; margin:5px; border-radius:4px; border:none; width:200px; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, get, child, remove } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCnoxoPsUFx3f71SAcV7vd5ex_ZUmOk3e0",
  authDomain: "cursestudio-chat.firebaseapp.com",
  databaseURL: "https://cursestudio-chat-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cursestudio-chat",
  storageBucket: "cursestudio-chat.appspot.com",
  messagingSenderId: "6190203668",
  appId: "1:6190203668:web:bb7475428ab3f96c62b801"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

// DOM
const loginDiv = document.getElementById("login");
const nickInput = document.getElementById("nick");
const skipBtn = document.getElementById("skip");
const loginBtn = document.getElementById("login-btn");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const fileInput = document.getElementById("file");
const channelsDiv = document.getElementById("channels");

let nick = localStorage.getItem("nick") || "";

// Kanallar
const channels = ["#Genel", "#Duyurular"];
let currentChannel = channels[0];

// Admin
const adminNick = "The1545";

// Login
function login(user) {
  nick = user;
  localStorage.setItem("nick", nick);
  loginDiv.style.display = "none";
  loadMessages();
}
if(nick) login(nick);

loginBtn.onclick = ()=>{ if(nickInput.value.trim()) login(nickInput.value.trim()); }
skipBtn.onclick = ()=>{
  const randomNick = "Guest"+Math.floor(Math.random()*1000);
  login(randomNick);
}

// Kanalları göster
channelsDiv.innerHTML = "";
channels.forEach(ch=>{
  const btn = document.createElement("button");
  btn.textContent = ch;
  btn.onclick = ()=>{ currentChannel = ch; messagesDiv.innerHTML=""; loadMessages(); }
  channelsDiv.appendChild(btn);
});

// Mesajları yükle
function loadMessages() {
  const chRef = ref(db, "channels/"+currentChannel);
  messagesDiv.innerHTML="";
  onChildAdded(chRef, (data)=>{
    const d = data.val();
    const div = document.createElement("div");
    div.className="message";
    if(d.file){
      div.innerHTML = `<span class="user">${d.user}:</span> <a href="${d.file}" target="_blank"><img src="${d.file}" style="max-width:200px;max-height:200px;"></a>`;
    } else {
      div.innerHTML = `<span class="user">${d.user}:</span> ${d.text}`;
    }
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// Gönder
sendBtn.onclick = ()=>{
  const text = msgInput.value.trim();
  if(!text && !fileInput.files[0]) return;

  if(fileInput.files[0]){
    const f = fileInput.files[0];
    const stRef = sref(storage, `files/${Date.now()}_${f.name}`);
    uploadBytes(stRef,f).then(snap=>{
      getDownloadURL(stRef).then(url=>{
        push(ref(db,"channels/"+currentChannel),{
          user:nick,
          file:url,
          time:Date.now()
        });
      });
    });
  }

  if(text){
    if(text.length>10000) text = text.substring(0,10000);
    push(ref(db,"channels/"+currentChannel),{
      user:nick,
      text:text,
      time:Date.now()
    });
  }
  msgInput.value="";
  fileInput.value="";
}

// LocalStorage sıfırla
document.addEventListener("keydown",(e)=>{
  if(e.ctrlKey && e.shiftKey && e.key==="F9"){
    localStorage.clear();
    push(ref(db,"channels/"+currentChannel),{
      user:"CurseBot",
      text:"Chat Yönetici Tarafından Sıfırlandı",
      time:Date.now()
    });
    location.reload();
  }
});
</script>
</head>
<body>
<div id="channels"></div>
<div id="chat-container">
  <div id="messages"></div>
  <div id="input-container">
    <input type="text" id="msg" placeholder="Mesaj yaz..."/>
    <input type="file" id="file"/>
    <button onclick="fileInput.click()">Foto</button>
    <button id="send">Gönder</button>
  </div>
</div>
<div id="login">
  <h2>Nick Gir</h2>
  <input type="text" id="nick" placeholder="Nick"/>
  <button id="login-btn">Giriş</button>
  <button id="skip">Oto Nick</button>
</div>
</body>
</html>
