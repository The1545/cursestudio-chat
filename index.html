<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CurseStudio Chat</title>
<style>
body{margin:0;font-family:sans-serif;background:#111;color:#eee;display:flex;flex-direction:column;height:100vh;}
#login,#chat{display:none;flex:1;align-items:center;justify-content:center;flex-direction:column;}
input,button,textarea{margin:5px;padding:8px;border-radius:4px;border:none}
button{cursor:pointer;background:#222;color:#eee}
#tabs{display:flex;margin-top:10px;}
.tab{padding:10px 20px;cursor:pointer;background:#222;margin-right:2px;border-radius:4px;}
.tab.active{background:#444;}
.channel{display:none;flex-direction:column;width:90vw;max-width:800px;}
#messages,#announceMessages{height:60vh;overflow-y:auto;background:#222;padding:10px;border-radius:5px;margin-top:10px;}
.message{margin-bottom:5px;padding:5px;border-radius:3px}
.admin{color:#0f0;font-weight:bold}
textarea{width:100%;border-radius:4px;}
.file-input{margin-top:5px}
</style>
</head>
<body>

<div id="login">
<h2>CurseStudio Chat</h2>
<input type="text" id="nick" placeholder="Nick" maxlength="20">
<input type="password" id="pass" placeholder="Åžifre">
<button id="loginBtn">GiriÅŸ Yap</button>
<button id="registerBtn">KayÄ±t Ol</button>
<button id="skipBtn">Random Nick ile Gir</button>
</div>

<div id="chat">
<h2>Merhaba <span id="nickShow"></span></h2>

<div id="tabs">
  <div class="tab active" data-channel="chat">Genel Chat</div>
  <div class="tab" data-channel="duyuru">#Duyurular</div>
</div>

<div id="chatContainer">
  <div id="chatChannel" class="channel" style="display:flex;flex-direction:column;">
    <div id="messages"></div>
  </div>
  <div id="announceChannel" class="channel">
    <div id="announceMessages"></div>
  </div>
</div>

<textarea id="msgInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." maxlength="10000"></textarea>
<input type="file" id="fileInput" class="file-input">
<button id="sendBtn">GÃ¶nder</button>
<button id="logoutBtn">Ã‡Ä±kÄ±ÅŸ Yap</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, remove, set, get } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCnoxoPsUFx3f71SAcV7vd5ex_ZUmOk3e0",
  authDomain: "cursestudio-chat.firebaseapp.com",
  databaseURL: "https://cursestudio-chat-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cursestudio-chat",
  storageBucket: "cursestudio-chat.appspot.com",
  messagingSenderId: "6190203668",
  appId: "1:6190203668:web:bb7475428ab3f96c62b801"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

let currentNick = localStorage.getItem('nick') || "";
let currentPass = localStorage.getItem('pass') || "";
const adminNick = "The1545";
const allowedChars = /[a-zA-Z0-9ÄŸÃ¼ÅŸi.<>|"Ã©!'^+%&/()=?_\-*#$Â½{}\[\]\\| ]/;

const loginDiv=document.getElementById('login');
const chatDiv=document.getElementById('chat');
const nickInput=document.getElementById('nick');
const passInput=document.getElementById('pass');
const loginBtn=document.getElementById('loginBtn');
const registerBtn=document.getElementById('registerBtn');
const skipBtn=document.getElementById('skipBtn');
const nickShow=document.getElementById('nickShow');
const messagesDiv=document.getElementById('messages');
const announceDiv=document.getElementById('announceMessages');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const logoutBtn=document.getElementById('logoutBtn');
const fileInput=document.getElementById('fileInput');
const tabs=document.querySelectorAll('.tab');
const chatChannelDiv=document.getElementById('chatChannel');
const announceChannelDiv=document.getElementById('announceChannel');

function validNick(nick){return nick.length && [...nick].every(c=>allowedChars.test(c))}
async function register(){let nick=nickInput.value.trim(),pass=passInput.value;if(!validNick(nick)){alert("Nick geÃ§ersiz");return;}await set(ref(db,'users/'+nick),{pass});loginNick(nick,pass);}
async function loginNick(nick,pass){let snap=await get(ref(db,'users/'+nick));if(snap.exists()&&snap.val().pass===pass||nick===currentNick){localStorage.setItem('nick',nick);localStorage.setItem('pass',pass);currentNick=nick;currentPass=pass;nickShow.textContent=nick;loginDiv.style.display='none';chatDiv.style.display='flex';initChat();}else alert("HatalÄ± nick veya ÅŸifre");}
function skipLogin(){let nick="User"+Math.floor(Math.random()*10000);currentNick=nick;nickShow.textContent=nick;loginDiv.style.display='none';chatDiv.style.display='flex';initChat();}

function initChat(){
  const msgRef=ref(db,'messages');
  onChildAdded(msgRef,(data)=>{
    const m=data.val();
    if(m.channel=='duyuru'&&currentNick!==adminNick) return;
    displayMessage(m);
  });
}

function displayMessage(m){
  const div=document.createElement('div');
  div.className='message';
  if(m.nick===adminNick) div.classList.add('admin');
  let content=m.text;
  if(m.fileUrl) content+='<br><a href="'+m.fileUrl+'" target="_blank">ðŸ“Ž Dosya</a>';
  div.innerHTML=`<strong>${m.nick}:</strong> ${content}`;
  if(m.channel==='duyuru') announceDiv.appendChild(div); else messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
  announceDiv.scrollTop=announceDiv.scrollHeight;
}

sendBtn.onclick=async()=>{
  let text=msgInput.value.trim(); if(!text&&!fileInput.files.length)return;
  if(text.length>10000){alert("Max 10000 karakter");return;}
  let channel='chat'; if(currentNick===adminNick&&activeChannel==='duyuru') channel='duyuru';
  let msg={nick:currentNick,text,channel};
  if(fileInput.files.length){
    let file=fileInput.files[0];
    let storageRef=sRef(storage,'files/'+Date.now()+"_"+file.name);
    await uploadBytes(storageRef,file);
    msg.fileUrl=await getDownloadURL(storageRef);
  }
  push(ref(db,'messages'),msg);
  msgInput.value='';fileInput.value='';
}

logoutBtn.onclick=()=>{localStorage.removeItem('nick');localStorage.removeItem('pass');location.reload();}
loginBtn.onclick=()=>loginNick(nickInput.value,passInput.value);
registerBtn.onclick=register;
skipBtn.onclick=skipLogin;

// Ctrl+Shift+F9 reset
document.addEventListener('keydown',e=>{
  if(e.ctrlKey&&e.shiftKey&&e.key==='F9'&&currentNick===adminNick){
    remove(ref(db,'messages')).then(()=>{push(ref(db,'messages'),{nick:'CurseBot',text:'Chat YÃ¶netici TarafÄ±ndan SÄ±fÄ±rlandÄ±',channel:'chat'});location.reload();});
  }
});

// Tab switch
let activeChannel='chat';
tabs.forEach(tab=>{
  tab.onclick=()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    activeChannel=tab.dataset.channel;
    if(activeChannel==='chat'){chatChannelDiv.style.display='flex';announceChannelDiv.style.display='none';}
    else{chatChannelDiv.style.display='none';announceChannelDiv.style.display='flex';}
  }
});

if(currentNick){loginNick(currentNick,currentPass);}else{loginDiv.style.display='flex';}
</script>
</body>
</html>
