<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CurseStudio Chat</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
:root {
--bg-tertiary:#202225; --bg-secondary:#2f3136; --bg-primary:#36393f;
--channel-hover:#34373c; --text-normal:#dcddde; --text-muted:#72767d;
--header-primary:#fff; --interactive-normal:#b9bbbe; --brand:#5865f2;
--online:#3ba55c; --offline:#747f8d; --danger:#ed4245;
}

*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body{background-color:var(--bg-primary);color:var(--text-normal);height:100vh;overflow:hidden;display:flex;}
::-webkit-scrollbar{width:8px;height:8px;}::-webkit-scrollbar-track{background-color:var(--bg-secondary);}::-webkit-scrollbar-thumb{background-color:var(--bg-tertiary);border-radius:4px;}

/* LOGIN */
#login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000;}
.login-box{background:var(--bg-secondary);padding:30px;border-radius:8px;width:350px;text-align:center;box-shadow:0 2px 10px 0 rgba(0,0,0,0.2);}
.login-box h2{color:var(--header-primary);margin-bottom:20px;}
.login-box input{width:100%;padding:10px;margin-bottom:10px;background:var(--bg-tertiary);border:1px solid #202225;color:white;border-radius:4px;}
.btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:white;transition:.2s;width:100%;margin-bottom:5px;}
.btn-primary{background-color:var(--brand);} .btn-primary:hover{background-color:#4752c4;}
.btn-secondary{background-color:var(--text-muted);} .btn-secondary:hover{background-color:#5e6165;}

/* SIDEBAR */
#sidebar{width:240px;background-color:var(--bg-secondary);display:flex;flex-direction:column;border-right:1px solid var(--bg-tertiary);}
.server-header{height:48px;padding:12px 16px;box-shadow:0 1px 0 rgba(4,4,5,0.2);font-weight:bold;color:var(--header-primary);}
.channels-list{padding:8px;flex:1;overflow-y:auto;}
.channel-item{display:flex;align-items:center;padding:8px;margin-bottom:2px;border-radius:4px;cursor:pointer;color:var(--text-muted);}
.channel-item:hover{background-color:var(--channel-hover);color:var(--text-normal);}
.channel-item.active{background-color:rgba(79,84,92,0.32);color:var(--header-primary);}
.channel-hash{margin-right:6px;font-size:20px;}
.users-list{padding:10px;background-color:var(--bg-secondary);border-top:1px solid var(--bg-tertiary);height:30%;overflow-y:auto;}
.user-item{display:flex;align-items:center;margin-bottom:8px;font-size:14px;}
.status-dot{width:10px;height:10px;border-radius:50%;margin-right:8px;background-color:var(--offline);}
.status-dot.online{background-color:var(--online);}

/* MAIN CHAT AREA */
#main-chat{flex:1;display:flex;flex-direction:column;background-color:var(--bg-primary);}
.chat-header{height:48px;padding:0 16px;display:flex;align-items:center;box-shadow:0 1px 0 rgba(4,4,5,0.02);border-bottom:1px solid rgba(4,4,5,0.2);font-weight:bold;color:var(--header-primary);}
#messages-container{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;}

/* MESSAGES */
.message{margin-bottom:15px;display:flex;flex-direction:column;}
.msg-header{display:flex;align-items:baseline;margin-bottom:4px;}
.msg-nick{font-weight:600;margin-right:8px;cursor:pointer;}
.msg-nick[data-online="true"]{color:var(--online);}
.msg-nick[data-online="false"]{color:var(--offline);}
.msg-timestamp{font-size:.75rem;color:var(--text-muted);}
.msg-content{color:var(--text-normal);white-space:pre-wrap;word-wrap:break-word;line-height:1.375rem;}
.msg-image{max-width:300px;max-height:300px;border-radius:4px;margin-top:5px;cursor:pointer;}
.admin-badge{background:var(--brand);color:white;font-size:10px;padding:2px 4px;border-radius:3px;margin-left:5px;vertical-align:middle;text-transform:uppercase;}

/* INPUT AREA */
.input-area{padding:0 16px 24px;}
.input-wrapper{background-color:#40444b;border-radius:8px;padding:10px;display:flex;align-items:center;}
.file-upload-label{cursor:pointer;color:var(--text-muted);margin-right:10px;font-size:24px;padding:0 5px;}
.file-upload-label:hover{color:var(--text-normal);}
#msg-input{background:transparent;border:none;color:var(--text-normal);flex:1;outline:none;font-size:1rem;}
#file-input{display:none;}

/* LOGOUT BUTTON */
#logout-btn{position:absolute;top:12px;right:12px;background:var(--danger);color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;}

/* MOBILE FIX */
@media(max-width:768px){
    #sidebar{width:60px;}
    .server-header{font-size:12px;padding:12px 6px;}
    .channels-list{padding:4px;}
    .channel-hash{display:none;}
    .users-list{height:20%;}
}
</style>
</head>
<body>

<div id="login-overlay">
<div class="login-box">
<h2>Hoşgeldiniz</h2>
<p style="font-size:12px;color:#aaa;margin-bottom:10px;">İzin verilen karakterler: A-Z,0-9 ve ğüşi.<>|"é!'^+%&/()=?_-*#$½{[]}\|</p>
<input type="text" id="nick-input" placeholder="Nickname giriniz..." maxlength="20">
<button class="btn btn-primary" onclick="login()">Giriş Yap</button>
<button class="btn btn-secondary" onclick="skipLogin()">Rastgele İsim (Skip)</button>
</div>
</div>

<div id="sidebar" style="display:none;">
<div class="server-header">CurseStudio</div>
<div class="channels-list">
<div class="channel-item active" onclick="switchChannel('Genel')"><span class="channel-hash">#</span> Genel</div>
<div class="channel-item" onclick="switchChannel('Duyurular')"><span class="channel-hash">#</span> Duyurular</div>
</div>
<div class="users-list"><div style="color:var(--text-muted);font-size:12px;font-weight:bold;margin-bottom:5px;">ÇEVRİMİÇİ</div><div id="users-container"></div></div>
</div>

<div id="main-chat" style="display:none;">
<button id="logout-btn" onclick="logout()">Çıkış Yap</button>
<div class="chat-header"><span class="channel-hash">#</span> <span id="current-channel-name">Genel</span></div>
<div id="messages-container"></div>
<div class="input-area" id="input-area-div">
<div class="input-wrapper">
<label for="file-input" class="file-upload-label">+</label>
<input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(this)">
<input type="text" id="msg-input" placeholder="#Genel kanalına mesaj yaz..." onkeypress="handleEnter(event)">
</div>
</div>
</div>

<script>
// FIREBASE
const firebaseConfig = {
apiKey: "", authDomain: "", databaseURL:"", projectId:"", storageBucket:"", messagingSenderId:"", appId:""
};
if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);}
const db = firebase.database();

// STATE
let currentUser={nick:null,uid:null,isAdmin:false};
let currentChannel='Genel';
const ADMIN_NICK="The1545";
const allowedCharsRegex=/^[a-zA-Z0-9ğüşi\.<>\|"é!'\^\+%&\/\(\)=\?_\-\*#\$½\{\[\]\}\|]+$/;
let messagesRef=null;
const renderedMessageIds=new Set();

// INIT
window.onload=function(){
    const storedNick=localStorage.getItem('chat_nick');
    const storedUid=localStorage.getItem('chat_uid');
    if(storedNick && storedUid) setupUser(storedNick,storedUid);

    document.addEventListener('keydown',function(e){
        if(e.ctrlKey && e.shiftKey && e.key==='F9'){
            e.preventDefault();
            if(currentUser.nick===ADMIN_NICK){triggerSystemReset();}
            else alert("Yetkiniz yok!");
        }
    });

    // Global reset listener
    db.ref('system/resetTrigger').on('value', snapshot=>{
        if(snapshot.val()){
            const lastReset = snapshot.val();
            const localReset = localStorage.getItem('last_reset_time');
            if(localReset != lastReset){
                localStorage.clear();
                localStorage.setItem('last_reset_time', lastReset);
                location.reload();
            }
        }
    });
};

// LOGIN
function login(){
    const nick=document.getElementById('nick-input').value.trim();
    if(!nick)return alert("Lütfen nick girin.");
    if(nick.length>20)return alert("Nick max 20 karakter olabilir.");
    if(!allowedCharsRegex.test(nick))return alert("Geçersiz karakter.");
    const uid='user_'+Date.now()+Math.random().toString(36).substr(2,9);
    setupUser(nick,uid);
}
function skipLogin(){
    const uid='user_'+Date.now()+Math.random().toString(36).substr(2,9);
    setupUser("User"+Math.floor(Math.random()*10000),uid);
}
function setupUser(nick,uid){
    currentUser.nick=nick; currentUser.uid=uid; currentUser.isAdmin=(nick===ADMIN_NICK);
    localStorage.setItem('chat_nick',nick); localStorage.setItem('chat_uid',uid);
    document.getElementById('login-overlay').style.display='none';
    document.getElementById('sidebar').style.display='flex';
    document.getElementById('main-chat').style.display='flex';
    initPresence(); loadMessages(currentChannel); updateInputState();
}

// PRESENCE
function initPresence(){
    const ref=db.ref('/status/'+currentUser.uid);
    const offline={state:'offline',last_changed:firebase.database.ServerValue.TIMESTAMP,nick:currentUser.nick};
    const online={state:'online',last_changed:firebase.database.ServerValue.TIMESTAMP,nick:currentUser.nick};

    db.ref('.info/connected').on('value',snap=>{
        if(snap.val()==false)return;
        ref.onDisconnect().set(offline).then(()=>{ref.set(online);});
    });

    db.ref('/status').on('value', snap=>{
        const users = snap.val()||{};
        renderUserList(users);
        document.querySelectorAll('.msg-nick').forEach(el=>{
            const nick=el.getAttribute('data-nick');
            const u=Object.values(users).find(x=>x.nick===nick);
            el.setAttribute('data-online',u && u.state==='online'?'true':'false');
        });
    });
}
function renderUserList(users){
    const container=document.getElementById('users-container'); container.innerHTML='';
    Object.values(users).forEach(u=>{
        if(u.state==='online'){
            const div=document.createElement('div'); div.className='user-item';
            div.innerHTML=`<div class="status-dot online"></div>${escapeHtml(u.nick)}`;
            container.appendChild(div);
        }
    });
}

// CHANNELS
function switchChannel(channel){
    currentChannel=channel;
    document.querySelectorAll('.channel-item').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('.channel-item').forEach(el=>{if(el.innerText.includes(channel))el.classList.add('active');});
    document.getElementById('current-channel-name').innerText=channel;
    loadMessages(channel); updateInputState();
}
function updateInputState(){
    const input=document.getElementById('msg-input'); const fileBtn=document.getElementById('file-input');
    const wrapper=document.querySelector('.input-wrapper');
    if(currentChannel==='Duyurular' && !currentUser.isAdmin){input.disabled=true;input.placeholder='Sadece yöneticiler yazabilir.';wrapper.style.opacity='0.5';fileBtn.disabled=true;}
    else{input.disabled=false;input.placeholder=`#${currentChannel} kanalına mesaj yaz...`;wrapper.style.opacity='1';fileBtn.disabled=false;}
}

// MESSAGES
function loadMessages(channel){
    const container=document.getElementById('messages-container'); container.innerHTML='';
    if(messagesRef) messagesRef.off();
    messagesRef=db.ref('messages/'+channel);
    messagesRef.limitToLast(100).on('child_added', snap=>{renderMessage(snap.val(),snap.key);});
}
function renderMessage(msg,key){
    if(renderedMessageIds.has(key)) return; renderedMessageIds.add(key);
    const container=document.getElementById('messages-container'); const div=document.createElement('div'); div.className='message';
    const badgeHtml=(msg.nick===ADMIN_NICK)?'<span class="admin-badge">Yönetici</span>':'';
    let contentHtml=`<div class="msg-content">${escapeHtml(msg.text)}</div>`;
    if(msg.image) contentHtml+=`<img src="${msg.image}" class="msg-image" onclick="window.open(this.src)">`;
    const time=new Date(msg.timestamp).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
    div.innerHTML=`<div class="msg-header"><span class="msg-nick" data-nick="${escapeHtml(msg.nick)}">${escapeHtml(msg.nick)}</span>${badgeHtml}<span class="msg-timestamp" style="margin-left:8px;">${time}</span></div>${contentHtml}`;
    container.appendChild(div); container.scrollTop=container.scrollHeight;

    // ONLINE UPDATE
    db.ref('/status').once('value').then(snap=>{
        const users=snap.val()||{}; const nickEl=div.querySelector('.msg-nick');
        const userObj=Object.values(users).find(u=>u.nick===msg.nick);
        nickEl.setAttribute('data-online',userObj && userObj.state==='online'?'true':'false');
    });
}

// SEND
function handleEnter(e){if(e.key==='Enter'){sendMessage();}}
function sendMessage(imageUrl=null){
    const input=document.getElementById('msg-input'); const text=input.value.trim();
    if(!text && !imageUrl) return;
    if(text.length>10000) return alert("Mesaj çok uzun!");
    if(currentChannel==='Duyurular' && !currentUser.isAdmin) return alert("Buraya yazamazsınız.");
    db.ref('messages/'+currentChannel).push({nick:currentUser.nick,text:text,image:imageUrl,timestamp:firebase.database.ServerValue.TIMESTAMP});
    input.value='';
}
function handleFileUpload(input){
    if(input.files && input.files[0]){
        const file=input.files[0]; const reader=new FileReader();
        if(file.size>2*1024*1024){alert("2MB altı resim yükleyin."); input.value=""; return;}
        reader.onload=function(e){sendMessage(e.target.result); input.value="";};
        reader.readAsDataURL(file);
    }
}

// RESET
function triggerSystemReset(){
    if(confirm("Tüm kullanıcıları sıfırlamak istiyor musunuz?")){
        const sysMsg={nick:"CurseBot",text:"Chat Yönetici Tarafından Sıfırlandı",timestamp:firebase.database.ServerValue.TIMESTAMP};
        db.ref('messages/Genel').push(sysMsg); db.ref('messages/Duyurular').push(sysMsg);
        setTimeout(()=>{db.ref('system/resetTrigger').set(Date.now());},1000);
    }
}

// LOGOUT
function logout(){localStorage.clear();location.reload();}

// UTIL
function escapeHtml(text){if(!text)return"";return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
</script>
</body>
</html>
